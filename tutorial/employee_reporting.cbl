IDENTIFICATION DIVISION.
PROGRAM-ID. Employee-Report.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT EMPLOYEE-FILE ASSIGN TO "EMPLOYEE.DAT"
        ORGANIZATION IS LINE SEQUENTIAL.
    SELECT REPORT-FILE ASSIGN TO "EMPLOYEE-REPORT.TXT"
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD EMPLOYEE-FILE.
01 EMPLOYEE-RECORD.
   05 EMP-ID              PIC 9(4).
   05 EMP-NAME            PIC X(20).
   05 EMP-DEPT            PIC X(10).
   05 EMP-SALARY          PIC 9(7)V99.

FD REPORT-FILE.
01 REPORT-RECORD          PIC X(80).

WORKING-STORAGE SECTION.
01 WS-EMP-ID              PIC 9(4).
01 WS-EMP-NAME            PIC X(20).
01 WS-EMP-DEPT            PIC X(10).
01 WS-EMP-SALARY          PIC 9(7)V99.

01 WS-DEPT-TOTAL          PIC 9(9)V99 VALUE ZERO.
01 WS-COMPANY-TOTAL       PIC 9(9)V99 VALUE ZERO.
01 WS-DEPT-CURRENT        PIC X(10) VALUE SPACES.
01 WS-END-OF-FILE         PIC X VALUE "N".

01 WS-REPORT-LINE         PIC X(80).
01 WS-LINE-CNT            PIC 9(3) VALUE ZERO.
01 WS-PAGE-NO             PIC 9(3) VALUE 1.

PROCEDURE DIVISION.
MAIN-PROCESS.
    OPEN INPUT EMPLOYEE-FILE
    OPEN OUTPUT REPORT-FILE

    PERFORM WRITE-HEADER

    PERFORM UNTIL WS-END-OF-FILE = "Y"
        READ EMPLOYEE-FILE INTO EMPLOYEE-RECORD
            AT END
                MOVE "Y" TO WS-END-OF-FILE
            NOT AT END
                PERFORM PROCESS-RECORD
    END-PERFORM

    PERFORM DEPT-BREAK
    PERFORM WRITE-FOOTER

    CLOSE EMPLOYEE-FILE
    CLOSE REPORT-FILE
    STOP RUN.

PROCESS-RECORD.
    IF WS-DEPT-CURRENT NOT = EMP-DEPT
        PERFORM DEPT-BREAK
        MOVE EMP-DEPT TO WS-DEPT-CURRENT
    END-IF

    MOVE EMP-ID TO WS-EMP-ID
    MOVE EMP-NAME TO WS-EMP-NAME
    MOVE EMP-DEPT TO WS-EMP-DEPT
    MOVE EMP-SALARY TO WS-EMP-SALARY

    ADD WS-EMP-SALARY TO WS-DEPT-TOTAL
    ADD WS-EMP-SALARY TO WS-COMPANY-TOTAL

    PERFORM WRITE-DETAIL-LINE.

DEPT-BREAK.
    IF WS-DEPT-CURRENT NOT = SPACES
        MOVE SPACES TO WS-REPORT-LINE
        STRING "TOTAL FOR DEPARTMENT: ", WS-DEPT-CURRENT
               " = " WS-DEPT-TOTAL
               DELIMITED BY SIZE INTO WS-REPORT-LINE
        PERFORM WRITE-REPORT-LINE
        PERFORM SKIP-LINE
    END-IF
    MOVE ZERO TO WS-DEPT-TOTAL.

WRITE-HEADER.
    MOVE SPACES TO WS-REPORT-LINE
    STRING "PAGE ", WS-PAGE-NO
           DELIMITED BY SIZE INTO WS-REPORT-LINE
    PERFORM WRITE-REPORT-LINE
    STRING "EMPLOYEE REPORT" DELIMITED BY SIZE
           INTO WS-REPORT-LINE
    PERFORM WRITE-REPORT-LINE
    STRING "ID    NAME                 DEPARTMENT   SALARY"
           DELIMITED BY SIZE INTO WS-REPORT-LINE
    PERFORM WRITE-REPORT-LINE
    PERFORM SKIP-LINE
    ADD 1 TO WS-PAGE-NO.

WRITE-FOOTER.
    MOVE SPACES TO WS-REPORT-LINE
    STRING "COMPANY TOTAL: " WS-COMPANY-TOTAL
           DELIMITED BY SIZE INTO WS-REPORT-LINE
    PERFORM WRITE-REPORT-LINE.

WRITE-DETAIL-LINE.
    MOVE SPACES TO WS-REPORT-LINE
    STRING WS-EMP-ID DELIMITED BY SIZE
           "    "
           WS-EMP-NAME DELIMITED BY SIZE
           "    "
           WS-EMP-DEPT DELIMITED BY SIZE
           "    "
           WS-EMP-SALARY DELIMITED BY SIZE
           INTO WS-REPORT-LINE
    PERFORM WRITE-REPORT-LINE.

WRITE-REPORT-LINE.
    WRITE REPORT-RECORD FROM WS-REPORT-LINE
    ADD 1 TO WS-LINE-CNT
    IF WS-LINE-CNT > 40
        PERFORM WRITE-HEADER
        MOVE 0 TO WS-LINE-CNT
    END-IF.

SKIP-LINE.
    MOVE SPACES TO WS-REPORT-LINE
    PERFORM WRITE-REPORT-LINE.
